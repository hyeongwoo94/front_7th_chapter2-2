# 카테고리 버튼 오류 수정 사항

## 문제 1: 카테고리 버튼 클릭이 작동하지 않음

### 원인

- `packages/react/src/core/dom.ts`의 `setDomProps`와 `updateDomProps` 함수에서 `data-` 속성을 처리할 때 `(dom as any)[key] = value`로 설정하고 있었습니다.
- 이 방식은 DOM 속성(property)으로 설정하는 것이지, HTML 속성(attribute)으로 설정하는 것이 아닙니다.
- `data-category1` 같은 속성은 `getAttribute("data-category1")`로 읽을 수 있도록 HTML 속성으로 설정되어야 합니다.
- 결과적으로 `e.target.getAttribute("data-category1")`가 `null`을 반환하여 이벤트 핸들러가 조기 종료되었습니다.

### 해결방안

- `setDomProps`와 `updateDomProps` 함수에서 `data-` 속성을 `setAttribute`를 사용하여 HTML 속성으로 설정하도록 수정했습니다.
- 일반 HTML 속성(id, type, value 등)도 `setAttribute`를 사용하도록 개선했습니다.

### 수정 코드

```typescript
// packages/react/src/core/dom.ts

// data- 속성 처리
if (key.startsWith("data-")) {
  dom.setAttribute(key, String(value ?? ""));
  continue;
}

// 일반 속성 (id, type, value 등)
if (key in dom || typeof value === "string" || typeof value === "number" || typeof value === "boolean") {
  if (typeof value === "boolean") {
    if (value) {
      dom.setAttribute(key, "");
    } else {
      dom.removeAttribute(key);
    }
  } else {
    dom.setAttribute(key, String(value ?? ""));
  }
} else {
  (dom as any)[key] = value;
}
```

### 이유

- React와 같은 프레임워크에서는 `data-` 속성을 HTML 속성으로 설정해야 `getAttribute()`로 읽을 수 있습니다.
- DOM 속성과 HTML 속성은 다르며, 이벤트 핸들러에서 `getAttribute()`를 사용하려면 HTML 속성으로 설정해야 합니다.

---

## 문제 2: 상세 페이지에서 홈으로 돌아올 때 URL의 카테고리 정보가 사라짐

### 원인

- `packages/app/src/services/productService.js`의 `loadProductsAndCategories()` 함수에서 `router.query = { current: undefined }`로 설정하면서 모든 쿼리 파라미터를 초기화했습니다.
- 상세 페이지에서 홈으로 돌아올 때 URL에 카테고리 정보(`category1`, `category2`)가 포함되어 있지만, `loadProductsAndCategories()`가 호출되면 이 정보가 사라졌습니다.
- 결과적으로 URL에는 카테고리 정보가 있지만, 실제로는 초기화되어 카테고리 뎁스가 표시되지 않았습니다.

### 해결방안

- `loadProductsAndCategories()` 함수에서 현재 쿼리 정보를 유지하면서 `current`만 초기화하도록 수정했습니다.
- URL에 있는 `category1`, `category2` 등의 정보가 유지되도록 했습니다.

### 수정 코드

```javascript
// packages/app/src/services/productService.js

export const loadProductsAndCategories = async () => {
  // URL의 카테고리 정보를 유지하면서 current만 초기화
  const currentQuery = router.query;
  router.query = { ...currentQuery, current: undefined }; // 카테고리 정보는 유지하고 첫 페이지로만 초기화
  // ... 나머지 코드
};
```

### 이유

- 사용자가 상세 페이지에서 카테고리 링크를 클릭하여 홈으로 돌아올 때, 선택한 카테고리 정보를 유지해야 합니다.
- 페이지 번호(`current`)만 초기화하고 카테고리 정보는 유지해야 사용자 경험이 좋아집니다.

---

## 문제 3: 상세 페이지에서 홈으로 돌아올 때 SearchBar의 카테고리가 표시되지 않음

### 원인

- `packages/app/src/pages/HomePage.jsx`의 `useEffect`에서 `loadProductsAndCategories()`를 호출하는데, 의존성 배열이 `[]`로 설정되어 있어 마운트 시에만 실행되었습니다.
- 상세 페이지에서 홈으로 돌아올 때는 컴포넌트가 재마운트되지 않고 업데이트만 되므로, `loadProductsAndCategories()`가 호출되지 않았습니다.
- 결과적으로 `categories`가 비어있어서 SearchBar에 카테고리 버튼들이 표시되지 않았습니다.

### 해결방안

- `router.subscribe`를 사용하여 라우터 변경을 직접 감지하도록 수정했습니다.
- 홈 페이지(`/`)로 돌아올 때마다 `categories`가 비어있으면 `loadProductsAndCategories()`를 호출하도록 했습니다.

### 수정 코드

```javascript
// packages/app/src/pages/HomePage.jsx

useEffect(() => {
  // 홈 페이지일 때만 실행
  const checkAndLoad = () => {
    const path = router.route?.path;
    if (path === "/") {
      registerScrollHandler();

      // 카테고리가 없거나 비어있으면 다시 로드
      const state = productStore.getState();
      if (!state.categories || Object.keys(state.categories).length === 0) {
        loadProductsAndCategories();
      }
    } else {
      unregisterScrollHandler();
    }
  };

  // 초기 체크
  checkAndLoad();

  // 라우터 변경 감지
  router.subscribe(checkAndLoad);

  return () => {
    unregisterScrollHandler();
  };
}, []);
```

### 이유

- SPA(Single Page Application)에서는 페이지 전환 시 컴포넌트가 재마운트되지 않고 업데이트만 되는 경우가 많습니다.
- 라우터 변경을 직접 감지하여 필요한 데이터를 다시 로드해야 합니다.
- `router.subscribe`를 사용하면 라우터가 변경될 때마다 콜백이 실행되어 적절한 시점에 데이터를 로드할 수 있습니다.

---

## 전체적인 문제 해결 흐름

1. **첫 번째 문제**: 카테고리 버튼 클릭이 작동하지 않음
   - `data-` 속성이 DOM에 반영되지 않아서 발생
   - `setAttribute`를 사용하여 HTML 속성으로 설정하도록 수정

2. **두 번째 문제**: URL의 카테고리 정보가 사라짐
   - `loadProductsAndCategories()`가 모든 쿼리 파라미터를 초기화
   - 현재 쿼리 정보를 유지하면서 `current`만 초기화하도록 수정

3. **세 번째 문제**: SearchBar의 카테고리가 표시되지 않음
   - 홈으로 돌아올 때 `categories`가 로드되지 않음
   - 라우터 변경을 감지하여 `categories`가 비어있으면 다시 로드하도록 수정

## 참고 파일

- `packages/react/src/core/dom.ts`: DOM 속성 설정 로직
- `packages/app/src/components/SearchBar.jsx`: 카테고리 버튼 컴포넌트
- `packages/app/src/services/productService.js`: 카테고리 로드 함수
- `packages/app/src/pages/HomePage.jsx`: 홈 페이지 컴포넌트
- `packages/app/src/lib/Router.js`: 라우터 구현
