# reconcileChildren 함수 조건부 렌더링 개선

<!--  문제 상태에따라 ui 렌더링을 해야하는데 모든것을 렌더링함 -->

## 개요

`reconcileChildren` 함수에서 조건부 렌더링(`null`, `false`)이 제대로 처리되지 않아 발생하던 문제를 해결하기 위한 개선 사항입니다.

## 문제점

1. **조건부 렌더링 처리 미흡**: `null`/`false`가 배열에 포함될 때 기존 자식이 제대로 제거되지 않음
2. **인덱스 매칭 오류**: key가 있는 자식과 없는 자식을 구분하지 못해 잘못된 매칭 발생
3. **중복 렌더링**: 상태 변경 시 이전 자식이 제거되지 않아 중복으로 렌더링됨
4. **사용되지 않은 자식 제거 실패**: 조건부 렌더링으로 사라진 자식이 DOM에서 제거되지 않음

## 해결 방법

### 1. usedInstances Set 추가

이미 사용된 인스턴스를 추적하여 중복 매칭을 방지합니다.

```typescript
const usedKeys = new Set<string | number>();
const usedInstances = new Set<Instance>();
```

- `usedKeys`: key가 있는 자식의 사용 여부 추적
- `usedInstances`: key가 없는 자식의 사용 여부 추적 (인스턴스 객체로 직접 추적)

### 2. 조건부 렌더링 처리 개선

`null`/`false` 처리 시 key가 없는 기존 자식을 제거합니다.

```typescript
if (isEmptyValue(newChild)) {
  childInstances.push(null);
  // key가 없는 기존 자식이 있으면 제거 (인덱스 매칭)
  while (renderedOldIndex < renderedOldChildren.length) {
    const oldChild = renderedOldChildren[renderedOldIndex];
    if (!oldChild) {
      renderedOldIndex++;
      continue;
    }
    // key가 있는 자식은 건너뛰기
    if (oldChild.key !== null) {
      renderedOldIndex++;
      continue;
    }
    // key가 없는 자식이면 제거
    removeInstance(parentDom, oldChild);
    renderedOldIndex++;
    break;
  }
  continue;
}
```

**핵심 로직**:

- key가 있는 자식은 건너뛰고 key가 없는 자식만 제거
- 실제 렌더링된 인덱스(`renderedOldIndex`)를 추적하여 정확한 매칭

### 3. 인덱스 매칭 로직 개선

key가 있는 자식과 없는 자식을 명확히 구분하여 매칭합니다.

```typescript
// Key로 매칭되지 않으면 인덱스로 매칭 (key가 없는 자식만)
if (!childInstance) {
  while (renderedOldIndex < renderedOldChildren.length) {
    const oldChild = renderedOldChildren[renderedOldIndex];
    if (!oldChild) {
      renderedOldIndex++;
      continue;
    }
    // 이미 사용된 인스턴스는 건너뛰기
    if (usedInstances.has(oldChild)) {
      renderedOldIndex++;
      continue;
    }
    // key가 있는 자식은 건너뛰기
    if (oldChild.key !== null) {
      renderedOldIndex++;
      continue;
    }
    // 타입이 같으면 매칭
    if (oldChild.node.type === newChild.type) {
      childInstance = reconcile(parentDom, oldChild, newChild, childPath);
      usedInstances.add(oldChild);
      renderedOldIndex++;
      break;
    }
    renderedOldIndex++;
  }
}
```

**핵심 로직**:

- 이미 사용된 인스턴스는 건너뛰기
- key가 있는 자식은 건너뛰기 (key로만 매칭)
- key가 없고 타입이 같은 경우에만 인덱스 매칭

### 4. 사용되지 않은 자식 제거 로직 개선

key 유무에 따라 다른 방식으로 사용 여부를 확인합니다.

```typescript
// 사용되지 않은 기존 자식 제거
for (let i = 0; i < oldChildren.length; i++) {
  const oldChild = oldChildren[i];
  if (!oldChild) continue;

  // key가 있는 자식 중 사용되지 않은 것 제거
  if (oldChild.key !== null && !usedKeys.has(oldChild.key)) {
    removeInstance(parentDom, oldChild);
  }
  // key가 없는 자식 중 사용되지 않은 것 제거
  else if (oldChild.key === null && !usedInstances.has(oldChild)) {
    removeInstance(parentDom, oldChild);
  }
}
```

**핵심 로직**:

- key가 있는 자식: `usedKeys` Set으로 확인
- key가 없는 자식: `usedInstances` Set으로 확인

## 개선 효과

### 1. 조건부 렌더링 정상 작동

```jsx
{
  cartSize > 0 && cartCount;
}
```

- `cartSize`가 0이 되면 `cartCount`가 DOM에서 제거됨
- 이전 자식이 남아있지 않음

### 2. 중복 렌더링 방지

- 상태 변경 시 이전 자식이 제대로 제거됨
- 장바구니 버튼이 중복으로 렌더링되지 않음

### 3. 정확한 인덱스 매칭

- key가 있는 자식과 없는 자식을 구분하여 처리
- 조건부 렌더링으로 인한 인덱스 변화를 정확히 추적

### 4. 메모리 누수 방지

- 사용되지 않은 자식이 DOM에서 제거됨
- 인스턴스가 올바르게 정리됨

## 주요 변경 사항 요약

| 항목                    | 변경 전              | 변경 후                           |
| ----------------------- | -------------------- | --------------------------------- |
| 사용 인스턴스 추적      | `usedKeys`만 사용    | `usedKeys` + `usedInstances` 사용 |
| 조건부 렌더링 처리      | 기존 자식 제거 안 함 | key가 없는 자식 제거              |
| 인덱스 매칭             | key 유무 구분 안 함  | key 유무 명확히 구분              |
| 사용되지 않은 자식 제거 | 개수 기반 제거       | 사용 여부 기반 제거               |

## 코드 위치

- 파일: `packages/react/src/core/reconciler.ts`
- 함수: `reconcileChildren` (라인 268-432)

## 테스트 시나리오

1. **조건부 렌더링 테스트**

   ```jsx
   {
     condition && <Component />;
   }
   ```

   - `condition`이 `false`가 되면 컴포넌트가 제거되어야 함

2. **중복 렌더링 방지 테스트**
   - 상태 변경 시 이전 자식이 남아있지 않아야 함
   - 장바구니 버튼이 하나만 표시되어야 함

3. **인덱스 매칭 테스트**
   - key가 있는 자식과 없는 자식이 혼합된 경우 정확히 매칭되어야 함

## 참고 사항

- `isEmptyValue`: `null`, `undefined`, `boolean` 값을 확인하는 유틸리티 함수
- `renderedOldChildren`: `null`이 아닌 실제 렌더링된 자식만 필터링한 배열
- `renderedOldIndex`: 실제 렌더링된 자식의 인덱스 추적
