# ë‹¨ê³„ 5: Reconciliation - í•™ìŠµ ë‚´ìš©

ì´ ë¬¸ì„œëŠ” ë‹¨ê³„ 5ì—ì„œ í•™ìŠµí•´ì•¼ í•  í•µì‹¬ ê°œë…ê³¼ êµ¬í˜„ ë‚´ìš©ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ“š í•µì‹¬ ê°œë…

### 1. Reconciliationì´ë€?

Reconciliation(ì¬ì¡°ì •)ì€ ì´ì „ Virtual DOMê³¼ ìƒˆë¡œìš´ Virtual DOMì„ ë¹„êµí•˜ì—¬ ìµœì†Œí•œì˜ DOM ë³€ê²½ë§Œ ìˆ˜í–‰í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

**ëª©ì **:
- DOM ì¡°ì‘ ìµœì†Œí™”
- ì„±ëŠ¥ ìµœì í™”
- ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ

**ì „ëµ**:
- íƒ€ì…/í‚¤ê°€ ê°™ìœ¼ë©´ â†’ ì—…ë°ì´íŠ¸ (DOM ì¬ì‚¬ìš©)
- íƒ€ì…/í‚¤ê°€ ë‹¤ë¥´ë©´ â†’ ì–¸ë§ˆìš´íŠ¸ í›„ ë§ˆìš´íŠ¸ (DOM êµì²´)

### 2. ë§ˆìš´íŠ¸ vs ì—…ë°ì´íŠ¸

**ë§ˆìš´íŠ¸ (Mount)**:
- ìƒˆë¡œìš´ ë…¸ë“œë¥¼ DOMì— ì¶”ê°€
- ì²« ë Œë”ë§ ë˜ëŠ” íƒ€ì…/í‚¤ ë³€ê²½ ì‹œ

**ì—…ë°ì´íŠ¸ (Update)**:
- ê¸°ì¡´ DOMì„ ì¬ì‚¬ìš©í•˜ê³  ì†ì„±ë§Œ ë³€ê²½
- íƒ€ì…/í‚¤ê°€ ê°™ì„ ë•Œ

### 3. ìì‹ ë…¸ë“œ ë§¤ì¹­

ìì‹ ë…¸ë“œë“¤ì„ íš¨ìœ¨ì ìœ¼ë¡œ ë§¤ì¹­í•˜ê¸° ìœ„í•´:

1. **Key ê¸°ë°˜ ë§¤ì¹­**: keyê°€ ìˆìœ¼ë©´ keyë¡œ ë§¤ì¹­
2. **ì¸ë±ìŠ¤ ê¸°ë°˜ ë§¤ì¹­**: keyê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­
3. **íƒ€ì… í™•ì¸**: íƒ€ì…ì´ ê°™ì•„ì•¼ ì¬ì‚¬ìš©

**ìš°ì„ ìˆœìœ„**:
1. Keyë¡œ ë§¤ì¹­ (keyê°€ ìˆê³  íƒ€ì…ì´ ê°™ìŒ)
2. ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­ (keyê°€ ì—†ê³  íƒ€ì…ì´ ê°™ìŒ)
3. ìƒˆë¡œ ë§ˆìš´íŠ¸ (ë§¤ì¹­ë˜ì§€ ì•ŠìŒ)

### 4. ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ ê´€ë¦¬

- **ë§ˆìš´íŠ¸**: ìƒˆ ê²½ë¡œ ìƒì„±
- **ì—…ë°ì´íŠ¸**: ê¸°ì¡´ ê²½ë¡œ ì¬ì‚¬ìš© (í›… ìƒíƒœ ìœ ì§€)

---

## ğŸ”§ êµ¬í˜„ í•¨ìˆ˜ ìƒì„¸

### 1. `reconcile(parentDom, instance, node, path)`

**ëª©ì **: ì´ì „ ì¸ìŠ¤í„´ìŠ¤ì™€ ìƒˆë¡œìš´ VNodeë¥¼ ë¹„êµí•˜ì—¬ DOMì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±° (unmount)
2. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆ ë…¸ë“œ ë§ˆìš´íŠ¸ (mount)
3. íƒ€ì…ì´ë‚˜ í‚¤ê°€ ë‹¤ë¥´ë©´ ê¸°ì¡´ ì œê±° í›„ ìƒˆë¡œ ë§ˆìš´íŠ¸
4. íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸ (update)

**êµ¬í˜„**:
```typescript
export const reconcile = (
  parentDom: HTMLElement,
  instance: Instance | null,
  node: VNode | null,
  path: string,
): Instance | null => {
  // 1. ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
  if (node === null) {
    if (instance) {
      removeInstance(parentDom, instance);
    }
    return null;
  }

  // 2. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆ ë…¸ë“œë¥¼ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
  if (!instance) {
    return mount(parentDom, node, path);
  }

  // 3. íƒ€ì…ì´ë‚˜ í‚¤ê°€ ë‹¤ë¥´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
  if (instance.node.type !== node.type || instance.key !== node.key) {
    removeInstance(parentDom, instance);
    return mount(parentDom, node, path);
  }

  // 4. íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
  return update(instance, node, parentDom, path);
};
```

**ìš”ì **:
- null ì²˜ë¦¬: ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ì–¸ë§ˆìš´íŠ¸
- íƒ€ì…/í‚¤ ë¹„êµ: íƒ€ì…ê³¼ í‚¤ê°€ ë‹¤ë¥´ë©´ ì™„ì „ êµì²´
- ì¬ì‚¬ìš©: íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì—…ë°ì´íŠ¸ (DOM ì¬ì‚¬ìš©)

---

### 2. `mount(parentDom, node, path)`

**ëª©ì **: ìƒˆë¡œìš´ VNodeë¥¼ DOMìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. TEXT_ELEMENT ì²˜ë¦¬
2. Fragment ì²˜ë¦¬
3. ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
4. DOM ìš”ì†Œ ì²˜ë¦¬

**í•µì‹¬ ë¡œì§**:
```typescript
const mount = (parentDom: HTMLElement, node: VNode, path: string): Instance => {
  // TEXT_ELEMENT ì²˜ë¦¬
  if (node.type === TEXT_ELEMENT) {
    const textNode = document.createTextNode(node.props.nodeValue || "");
    const instance: Instance = {
      kind: NodeTypes.TEXT,
      dom: textNode,
      node,
      children: [],
      key: node.key,
      path,
    };
    parentDom.appendChild(textNode);
    return instance;
  }

  // Fragment ì²˜ë¦¬
  if (node.type === Fragment) {
    // ìì‹ë“¤ë§Œ ë§ˆìš´íŠ¸, DOMì€ null
    // ...
  }

  // ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
  if (typeof node.type === "function") {
    return mountComponent(parentDom, node, path);
  }

  // DOM ìš”ì†Œ ì²˜ë¦¬
  const dom = document.createElement(node.type as string);
  setDomProps(dom as HTMLElement, node.props);
  // ìì‹ë“¤ ì¬ê·€ ë§ˆìš´íŠ¸
  // ...
  return instance;
};
```

**ìš”ì **:
- TEXT_ELEMENT: Text ë…¸ë“œ ìƒì„±
- Fragment: DOM ì—†ìŒ, ìì‹ë§Œ ë§ˆìš´íŠ¸
- ì»´í¬ë„ŒíŠ¸: `mountComponent` í˜¸ì¶œ
- DOM ìš”ì†Œ: `createElement`ë¡œ ìƒì„± í›„ ì†ì„± ì„¤ì •

---

### 3. `mountComponent(parentDom, node, path)`

**ëª©ì **: í•¨ìˆ˜ ì»´í¬ë„ŒíŠ¸ë¥¼ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ ìƒì„±
2. `enterComponent`ë¡œ í›… ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
3. ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ ì‹¤í–‰
4. ìì‹ VNode ë§ˆìš´íŠ¸
5. `exitComponent`ë¡œ ì •ë¦¬

**êµ¬í˜„**:
```typescript
const mountComponent = (
  parentDom: HTMLElement,
  node: VNode,
  path: string,
): Instance => {
  const Component = node.type as React.ComponentType<any>;
  const componentPath = createChildPath(path, node.key, 0, node.type);

  enterComponent(componentPath);

  try {
    const childNode = Component(node.props);
    if (childNode === null) {
      // null ë°˜í™˜ ì²˜ë¦¬
      return instance;
    }

    const childPath = createChildPath(componentPath, childNode.key, 0, childNode.type);
    const childInstance = mount(parentDom, childNode, childPath);

    const instance: Instance = {
      kind: NodeTypes.COMPONENT,
      dom: getFirstDom(childInstance),
      node,
      children: [],
      key: node.key,
      path: componentPath,
      childInstance,
    };

    return instance;
  } finally {
    exitComponent();
  }
};
```

**ìš”ì **:
- try-finally: `enterComponent`/`exitComponent` ìŒ ë³´ì¥
- ì»´í¬ë„ŒíŠ¸ ì‹¤í–‰: propsë¡œ ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
- ìì‹ ë§ˆìš´íŠ¸: ë°˜í™˜ëœ VNodeë¥¼ ì¬ê·€ì ìœ¼ë¡œ ë§ˆìš´íŠ¸
- childInstance ì €ì¥: ì»´í¬ë„ŒíŠ¸ì˜ ìì‹ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

---

### 4. `update(oldInstance, newNode, parentDom, path)`

**ëª©ì **: ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒˆë¡œìš´ VNodeë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. TEXT_ELEMENT ì—…ë°ì´íŠ¸
2. Fragment ì—…ë°ì´íŠ¸
3. ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸
4. DOM ìš”ì†Œ ì—…ë°ì´íŠ¸

**í•µì‹¬ ë¡œì§**:
```typescript
const update = (
  oldInstance: Instance,
  newNode: VNode,
  parentDom: HTMLElement,
  path: string,
): Instance => {
  // TEXT_ELEMENT ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.TEXT && newNode.type === TEXT_ELEMENT) {
    if (oldInstance.dom) {
      (oldInstance.dom as Text).nodeValue = newNode.props.nodeValue || "";
    }
    oldInstance.node = newNode;
    return oldInstance;
  }

  // Fragment ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.FRAGMENT && newNode.type === Fragment) {
    reconcileChildren(parentDom, oldInstance, (newNode.props.children || []) as VNode[], path);
    oldInstance.dom = getFirstDomFromChildren(oldInstance.children);
    oldInstance.node = newNode;
    return oldInstance;
  }

  // ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.COMPONENT) {
    return updateComponent(oldInstance, newNode, parentDom);
  }

  // DOM ìš”ì†Œ ì²˜ë¦¬
  if (oldInstance.dom) {
    updateDomProps(oldInstance.dom as HTMLElement, oldInstance.node.props, newNode.props);
  }
  reconcileChildren(parentDom, oldInstance, (newNode.props.children || []) as VNode[], path);
  oldInstance.node = newNode;
  return oldInstance;
};
```

**ìš”ì **:
- TEXT_ELEMENT: `nodeValue`ë§Œ ì—…ë°ì´íŠ¸
- Fragment: ìì‹ë§Œ ì¬ì¡°ì •
- ì»´í¬ë„ŒíŠ¸: `updateComponent` í˜¸ì¶œ
- DOM ìš”ì†Œ: ì†ì„± ì—…ë°ì´íŠ¸ í›„ ìì‹ ì¬ì¡°ì •

---

### 5. `updateComponent(oldInstance, newNode, parentDom)`

**ëª©ì **: í•¨ìˆ˜ ì»´í¬ë„ŒíŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. ê¸°ì¡´ ê²½ë¡œë¡œ `enterComponent` í˜¸ì¶œ
2. ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ ì¬ì‹¤í–‰
3. ìì‹ reconcile í˜¸ì¶œ
4. `exitComponent`ë¡œ ì •ë¦¬

**êµ¬í˜„**:
```typescript
const updateComponent = (
  oldInstance: Instance,
  newNode: VNode,
  parentDom: HTMLElement,
): Instance => {
  const Component = newNode.type as React.ComponentType<any>;
  const path = oldInstance.path;  // ê¸°ì¡´ ê²½ë¡œ ì¬ì‚¬ìš©!

  enterComponent(path);

  try {
    const childNode = Component(newNode.props);
    if (childNode === null) {
      // null ì²˜ë¦¬
      return oldInstance;
    }

    const container = oldInstance.childInstance?.dom
      ? (oldInstance.childInstance.dom as HTMLElement).parentElement || parentDom
      : parentDom;

    const childPath = createChildPath(path, childNode.key, 0, childNode.type);
    const childInstance = reconcile(
      container as HTMLElement,
      oldInstance.childInstance || null,
      childNode,
      childPath,
    );

    oldInstance.childInstance = childInstance;
    oldInstance.dom = getFirstDom(childInstance);
    oldInstance.node = newNode;

    return oldInstance;
  } finally {
    exitComponent();
  }
};
```

**ìš”ì **:
- ê¸°ì¡´ ê²½ë¡œ ì‚¬ìš©: í›… ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ê°™ì€ ê²½ë¡œ ì‚¬ìš©
- ì»¨í…Œì´ë„ˆ ì°¾ê¸°: ìì‹ DOMì˜ ë¶€ëª¨ ë˜ëŠ” parentDom ì‚¬ìš©
- ìì‹ reconcile: ì¬ê·€ì ìœ¼ë¡œ reconcile í˜¸ì¶œ
- DOM ì—…ë°ì´íŠ¸: ì²« DOM ì°¸ì¡° ì—…ë°ì´íŠ¸

---

### 6. `reconcileChildren(parentDom, instance, newChildren, parentPath)`

**ëª©ì **: ìì‹ ë…¸ë“œë“¤ì„ ì¬ì¡°ì •í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ìˆœì„œ**:
1. Key ê¸°ë°˜ Map ìƒì„±
2. ìƒˆ ìì‹ ì²˜ë¦¬ (keyë¡œ ë§¤ì¹­ ë˜ëŠ” ìƒˆë¡œ ë§ˆìš´íŠ¸)
3. ì‚¬ìš©ë˜ì§€ ì•Šì€ ê¸°ì¡´ ìì‹ ì œê±°

**í•µì‹¬ ë¡œì§**:
```typescript
const reconcileChildren = (
  parentDom: HTMLElement,
  instance: Instance,
  newChildren: VNode[],
  parentPath: string,
): void => {
  const oldChildren = instance.children || [];
  const childInstances: (Instance | null)[] = [];

  // Key ê¸°ë°˜ Map ìƒì„±
  const keyMap = new Map<string | number, Instance>();
  for (const oldChild of oldChildren) {
    if (oldChild && oldChild.key !== null) {
      keyMap.set(oldChild.key, oldChild);
    }
  }

  const usedKeys = new Set<string | number>();

  // ìƒˆ ìì‹ ì²˜ë¦¬
  for (let i = 0; i < newChildren.length; i++) {
    const newChild = newChildren[i];
    if (isEmptyValue(newChild)) {
      childInstances.push(null);
      continue;
    }

    let childInstance: Instance | null = null;

    // Keyë¡œ ë§¤ì¹­
    if (newChild.key !== null && keyMap.has(newChild.key)) {
      const matched = keyMap.get(newChild.key)!;
      if (matched.node.type === newChild.type) {
        childInstance = reconcile(parentDom, matched, newChild, childPath);
        usedKeys.add(newChild.key);
      }
    }

    // Keyë¡œ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­
    if (!childInstance && i < oldChildren.length) {
      const oldChild = oldChildren[i];
      if (oldChild && oldChild.node.type === newChild.type && oldChild.key === null) {
        childInstance = reconcile(parentDom, oldChild, newChild, childPath);
      }
    }

    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ë§ˆìš´íŠ¸
    if (!childInstance) {
      childInstance = mount(parentDom, newChild, childPath);
    }

    childInstances.push(childInstance);
  }

  // ì‚¬ìš©ë˜ì§€ ì•Šì€ ê¸°ì¡´ ìì‹ ì œê±°
  for (let i = 0; i < oldChildren.length; i++) {
    const oldChild = oldChildren[i];
    if (!oldChild) continue;

    if (oldChild.key !== null && !usedKeys.has(oldChild.key)) {
      removeInstance(parentDom, oldChild);
    } else if (oldChild.key === null && i >= newChildren.length) {
      removeInstance(parentDom, oldChild);
    }
  }

  instance.children = childInstances;
};
```

**ìš”ì **:
- Key ìš°ì„ : keyê°€ ìˆìœ¼ë©´ keyë¡œ ë§¤ì¹­
- ì¸ë±ìŠ¤ ë§¤ì¹­: keyê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­
- íƒ€ì… í™•ì¸: íƒ€ì…ì´ ê°™ì•„ì•¼ ì¬ì‚¬ìš©
- ë¯¸ì‚¬ìš© ì œê±°: ì‚¬ìš©ë˜ì§€ ì•Šì€ ìì‹ ì œê±°

---

## ğŸ’¡ í•µì‹¬ ì›ì¹™

### 1. Reconciliation ì „ëµ

| ì¡°ê±´ | ë™ì‘ |
|------|------|
| íƒ€ì…/í‚¤ ë‹¤ë¦„ | ì–¸ë§ˆìš´íŠ¸ í›„ ë§ˆìš´íŠ¸ |
| íƒ€ì…/í‚¤ ê°™ìŒ | ì—…ë°ì´íŠ¸ (DOM ì¬ì‚¬ìš©) |

### 2. ìì‹ ë§¤ì¹­ ìš°ì„ ìˆœìœ„

1. **Keyë¡œ ë§¤ì¹­** (keyê°€ ìˆê³  íƒ€ì…ì´ ê°™ìŒ)
2. **ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­** (keyê°€ ì—†ê³  íƒ€ì…ì´ ê°™ìŒ)
3. **ìƒˆë¡œ ë§ˆìš´íŠ¸** (ë§¤ì¹­ë˜ì§€ ì•ŠìŒ)

### 3. Instance ì¬ì‚¬ìš©

- **ê°™ì€ íƒ€ì…/í‚¤**: DOM ì¬ì‚¬ìš©, ì†ì„±ë§Œ ì—…ë°ì´íŠ¸
- **ë‹¤ë¥¸ íƒ€ì…/í‚¤**: DOM ì œê±° í›„ ìƒˆë¡œ ìƒì„±
- **ì„±ëŠ¥**: ìµœì†Œí•œì˜ DOM ë³€ê²½ìœ¼ë¡œ ìµœì í™”

### 4. ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ

- **ë§ˆìš´íŠ¸**: ìƒˆ ê²½ë¡œ ìƒì„±
- **ì—…ë°ì´íŠ¸**: ê¸°ì¡´ ê²½ë¡œ ì¬ì‚¬ìš© (í›… ìƒíƒœ ìœ ì§€)

---

## ğŸ¯ ì‹¤ìŠµ ì˜ˆì‹œ

### ì˜ˆì‹œ 1: íƒ€ì… ë³€ê²½

```typescript
// ì²« ë Œë”ë§
<div>Hello</div>
  â†’ mount() â†’ DOM ìƒì„±

// ë‘ ë²ˆì§¸ ë Œë”ë§ (íƒ€ì… ë³€ê²½)
<span>Hello</span>
  â†’ reconcile() â†’ íƒ€ì… ë‹¤ë¦„
  â†’ removeInstance() â†’ ê¸°ì¡´ ì œê±°
  â†’ mount() â†’ ìƒˆë¡œ ìƒì„±
```

### ì˜ˆì‹œ 2: ì†ì„± ì—…ë°ì´íŠ¸

```typescript
// ì²« ë Œë”ë§
<div className="old">Hello</div>
  â†’ mount() â†’ DOM ìƒì„±

// ë‘ ë²ˆì§¸ ë Œë”ë§ (ì†ì„± ë³€ê²½)
<div className="new">Hello</div>
  â†’ reconcile() â†’ íƒ€ì…/í‚¤ ê°™ìŒ
  â†’ update() â†’ updateDomProps() â†’ ì†ì„±ë§Œ ë³€ê²½
```

### ì˜ˆì‹œ 3: Key ê¸°ë°˜ ë§¤ì¹­

```typescript
// ì²« ë Œë”ë§
<ul>
  <li key="1">A</li>
  <li key="2">B</li>
</ul>

// ë‘ ë²ˆì§¸ ë Œë”ë§ (ìˆœì„œ ë³€ê²½)
<ul>
  <li key="2">B</li>
  <li key="1">A</li>
</ul>
  â†’ reconcileChildren()
  â†’ key="2"ë¡œ ë§¤ì¹­ â†’ DOM ì¬ì‚¬ìš©, ìœ„ì¹˜ë§Œ ì´ë™
  â†’ key="1"ë¡œ ë§¤ì¹­ â†’ DOM ì¬ì‚¬ìš©, ìœ„ì¹˜ë§Œ ì´ë™
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ê²½ë¡œ ì¬ì‚¬ìš©**: updateComponentì—ì„œ ìƒˆ ê²½ë¡œ ìƒì„±í•˜ë©´ í›… ìƒíƒœ ì†ì‹¤ âŒ
2. **íƒ€ì… í™•ì¸ ëˆ„ë½**: ìì‹ ë§¤ì¹­ ì‹œ íƒ€ì… í™•ì¸ ì•ˆ í•¨ âŒ
3. **ì»¨í…Œì´ë„ˆ ì°¾ê¸°**: ìì‹ DOMì˜ ë¶€ëª¨ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì°¾ì§€ ì•ŠìŒ âŒ
4. **try-finally ëˆ„ë½**: enterComponent/exitComponent ìŒ ë³´ì¥ ì•ˆ í•¨ âŒ
5. **Key ë§¤ì¹­ ìš°ì„ **: Keyê°€ ìˆìœ¼ë©´ ì¸ë±ìŠ¤ ë¬´ì‹œ âŒ

---

## ğŸ’¡ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜

### 1. ê²½ë¡œ ì¬ì‚¬ìš© ëˆ„ë½

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ
const updateComponent = (oldInstance, newNode, parentDom) => {
  const path = createChildPath(...);  // ìƒˆ ê²½ë¡œ ìƒì„±!
  // í›… ìƒíƒœ ì†ì‹¤!
};

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
const updateComponent = (oldInstance, newNode, parentDom) => {
  const path = oldInstance.path;  // ê¸°ì¡´ ê²½ë¡œ ì¬ì‚¬ìš©
};
```

### 2. íƒ€ì… í™•ì¸ ëˆ„ë½

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ
if (keyMap.has(newChild.key)) {
  const matched = keyMap.get(newChild.key)!;
  childInstance = reconcile(..., matched, newChild, ...);
  // íƒ€ì… í™•ì¸ ì•ˆ í•¨!
}

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
if (keyMap.has(newChild.key)) {
  const matched = keyMap.get(newChild.key)!;
  if (matched.node.type === newChild.type) {  // íƒ€ì… í™•ì¸
    childInstance = reconcile(..., matched, newChild, ...);
  }
}
```

### 3. try-finally ëˆ„ë½

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ
enterComponent(path);
const result = Component(props);
exitComponent();  // ì—ëŸ¬ ë°œìƒ ì‹œ í˜¸ì¶œ ì•ˆ ë¨!

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
enterComponent(path);
try {
  const result = Component(props);
} finally {
  exitComponent();  // í•­ìƒ í˜¸ì¶œ
}
```

---

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

ì´ì œ Reconciliationì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ” ê¸°ë³¸ Hook ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ë‹¤ìŒ ë‹¨ê³„**: [ë‹¨ê³„ 6 - ê¸°ë³¸ Hook ì‹œìŠ¤í…œ](../step6/í•™ìŠµ_ë‚´ìš©.md)

