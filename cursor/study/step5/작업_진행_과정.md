# ë‹¨ê³„ 5: ì‘ì—… ì§„í–‰ ê³¼ì •

Teacherê°€ ë‹¨ê³„ 5ë¥¼ êµ¬í˜„í•œ ê³¼ì •ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.

## ğŸ“‹ ì‘ì—… ìˆœì„œ

1. **ê¸°ì¡´ ì½”ë“œ êµ¬ì¡° íŒŒì•…** â†’ reconcile í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ í™•ì¸
2. **í•µì‹¬ reconcile í•¨ìˆ˜ êµ¬í˜„** â†’ íƒ€ì…/í‚¤ ë¹„êµ ë° ë¶„ê¸° ì²˜ë¦¬
3. **ë§ˆìš´íŠ¸ í•¨ìˆ˜ êµ¬í˜„** â†’ mount, mountComponent
4. **ì—…ë°ì´íŠ¸ í•¨ìˆ˜ êµ¬í˜„** â†’ update, updateComponent
5. **ìì‹ ì¬ì¡°ì • êµ¬í˜„** â†’ reconcileChildren

---

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### 1. `reconcile` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±° (unmount)
2. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆ ë…¸ë“œ ë§ˆìš´íŠ¸ (mount)
3. íƒ€ì…ì´ë‚˜ í‚¤ê°€ ë‹¤ë¥´ë©´ ê¸°ì¡´ ì œê±° í›„ ìƒˆë¡œ ë§ˆìš´íŠ¸
4. íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸ (update)

**êµ¬í˜„**:

```typescript
export const reconcile = (
  parentDom: HTMLElement,
  instance: Instance | null,
  node: VNode | null,
  path: string,
): Instance | null => {
  // 1. ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
  if (node === null) {
    if (instance) {
      removeInstance(parentDom, instance);
    }
    return null;
  }

  // 2. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆ ë…¸ë“œë¥¼ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
  if (!instance) {
    return mount(parentDom, node, path);
  }

  // 3. íƒ€ì…ì´ë‚˜ í‚¤ê°€ ë‹¤ë¥´ë©´ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
  if (instance.node.type !== node.type || instance.key !== node.key) {
    removeInstance(parentDom, instance);
    return mount(parentDom, node, path);
  }

  // 4. íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
  return update(instance, node, parentDom, path);
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **null ì²˜ë¦¬**: ìƒˆ ë…¸ë“œê°€ nullì´ë©´ ì–¸ë§ˆìš´íŠ¸
- **íƒ€ì…/í‚¤ ë¹„êµ**: íƒ€ì…ê³¼ í‚¤ê°€ ë‹¤ë¥´ë©´ ì™„ì „ êµì²´
- **ì¬ì‚¬ìš©**: íƒ€ì…ê³¼ í‚¤ê°€ ê°™ìœ¼ë©´ ì—…ë°ì´íŠ¸ (DOM ì¬ì‚¬ìš©)

---

### 2. `mount` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. TEXT_ELEMENT ì²˜ë¦¬
2. Fragment ì²˜ë¦¬
3. ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
4. DOM ìš”ì†Œ ì²˜ë¦¬

**í•µì‹¬ ë¡œì§**:

```typescript
const mount = (parentDom: HTMLElement, node: VNode, path: string): Instance => {
  // TEXT_ELEMENT ì²˜ë¦¬
  if (node.type === TEXT_ELEMENT) {
    const textNode = document.createTextNode(node.props.nodeValue || "");
    const instance: Instance = {
      kind: NodeTypes.TEXT,
      dom: textNode,
      node,
      children: [],
      key: node.key,
      path,
    };
    parentDom.appendChild(textNode);
    return instance;
  }

  // Fragment ì²˜ë¦¬
  if (node.type === Fragment) {
    // ìì‹ë“¤ë§Œ ë§ˆìš´íŠ¸, DOMì€ null
    // ...
  }

  // ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
  if (typeof node.type === "function") {
    return mountComponent(parentDom, node, path);
  }

  // DOM ìš”ì†Œ ì²˜ë¦¬
  const dom = document.createElement(node.type as string);
  setDomProps(dom as HTMLElement, node.props);
  // ìì‹ë“¤ ì¬ê·€ ë§ˆìš´íŠ¸
  // ...
  return instance;
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **TEXT_ELEMENT**: Text ë…¸ë“œ ìƒì„±
- **Fragment**: DOM ì—†ìŒ, ìì‹ë§Œ ë§ˆìš´íŠ¸
- **ì»´í¬ë„ŒíŠ¸**: `mountComponent` í˜¸ì¶œ
- **DOM ìš”ì†Œ**: `createElement`ë¡œ ìƒì„± í›„ ì†ì„± ì„¤ì •

---

### 3. `mountComponent` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ ìƒì„±
2. `enterComponent`ë¡œ í›… ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
3. ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ ì‹¤í–‰
4. ìì‹ VNode ë§ˆìš´íŠ¸
5. `exitComponent`ë¡œ ì •ë¦¬

**êµ¬í˜„**:

```typescript
const mountComponent = (
  parentDom: HTMLElement,
  node: VNode,
  path: string,
): Instance => {
  const Component = node.type as React.ComponentType<any>;
  const componentPath = createChildPath(path, node.key, 0, node.type);

  enterComponent(componentPath);

  try {
    const childNode = Component(node.props);
    if (childNode === null) {
      // null ë°˜í™˜ ì²˜ë¦¬
      return instance;
    }

    const childPath = createChildPath(componentPath, childNode.key, 0, childNode.type);
    const childInstance = mount(parentDom, childNode, childPath);

    const instance: Instance = {
      kind: NodeTypes.COMPONENT,
      dom: getFirstDom(childInstance),
      node,
      children: [],
      key: node.key,
      path: componentPath,
      childInstance,
    };

    return instance;
  } finally {
    exitComponent();
  }
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **try-finally**: `enterComponent`/`exitComponent` ìŒ ë³´ì¥
- **ì»´í¬ë„ŒíŠ¸ ì‹¤í–‰**: propsë¡œ ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
- **ìì‹ ë§ˆìš´íŠ¸**: ë°˜í™˜ëœ VNodeë¥¼ ì¬ê·€ì ìœ¼ë¡œ ë§ˆìš´íŠ¸
- **childInstance ì €ì¥**: ì»´í¬ë„ŒíŠ¸ì˜ ìì‹ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

---

### 4. `update` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. TEXT_ELEMENT ì—…ë°ì´íŠ¸
2. Fragment ì—…ë°ì´íŠ¸
3. ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸
4. DOM ìš”ì†Œ ì—…ë°ì´íŠ¸

**í•µì‹¬ ë¡œì§**:

```typescript
const update = (
  oldInstance: Instance,
  newNode: VNode,
  parentDom: HTMLElement,
  path: string,
): Instance => {
  // TEXT_ELEMENT ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.TEXT && newNode.type === TEXT_ELEMENT) {
    if (oldInstance.dom) {
      (oldInstance.dom as Text).nodeValue = newNode.props.nodeValue || "";
    }
    oldInstance.node = newNode;
    return oldInstance;
  }

  // Fragment ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.FRAGMENT && newNode.type === Fragment) {
    reconcileChildren(parentDom, oldInstance, (newNode.props.children || []) as VNode[], path);
    oldInstance.dom = getFirstDomFromChildren(oldInstance.children);
    oldInstance.node = newNode;
    return oldInstance;
  }

  // ì»´í¬ë„ŒíŠ¸ ì²˜ë¦¬
  if (oldInstance.kind === NodeTypes.COMPONENT) {
    return updateComponent(oldInstance, newNode, parentDom);
  }

  // DOM ìš”ì†Œ ì²˜ë¦¬
  if (oldInstance.dom) {
    updateDomProps(oldInstance.dom as HTMLElement, oldInstance.node.props, newNode.props);
  }
  reconcileChildren(parentDom, oldInstance, (newNode.props.children || []) as VNode[], path);
  oldInstance.node = newNode;
  return oldInstance;
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **TEXT_ELEMENT**: `nodeValue`ë§Œ ì—…ë°ì´íŠ¸
- **Fragment**: ìì‹ë§Œ ì¬ì¡°ì •
- **ì»´í¬ë„ŒíŠ¸**: `updateComponent` í˜¸ì¶œ
- **DOM ìš”ì†Œ**: ì†ì„± ì—…ë°ì´íŠ¸ í›„ ìì‹ ì¬ì¡°ì •

---

### 5. `updateComponent` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. ê¸°ì¡´ ê²½ë¡œë¡œ `enterComponent` í˜¸ì¶œ
2. ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ ì¬ì‹¤í–‰
3. ìì‹ reconcile í˜¸ì¶œ
4. `exitComponent`ë¡œ ì •ë¦¬

**êµ¬í˜„**:

```typescript
const updateComponent = (
  oldInstance: Instance,
  newNode: VNode,
  parentDom: HTMLElement,
): Instance => {
  const Component = newNode.type as React.ComponentType<any>;
  const path = oldInstance.path;

  enterComponent(path);

  try {
    const childNode = Component(newNode.props);
    if (childNode === null) {
      // null ì²˜ë¦¬
      return oldInstance;
    }

    const container = oldInstance.childInstance?.dom
      ? (oldInstance.childInstance.dom as HTMLElement).parentElement || parentDom
      : parentDom;

    const childPath = createChildPath(path, childNode.key, 0, childNode.type);
    const childInstance = reconcile(
      container as HTMLElement,
      oldInstance.childInstance || null,
      childNode,
      childPath,
    );

    oldInstance.childInstance = childInstance;
    oldInstance.dom = getFirstDom(childInstance);
    oldInstance.node = newNode;

    return oldInstance;
  } finally {
    exitComponent();
  }
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **ê¸°ì¡´ ê²½ë¡œ ì‚¬ìš©**: í›… ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ê°™ì€ ê²½ë¡œ ì‚¬ìš©
- **ì»¨í…Œì´ë„ˆ ì°¾ê¸°**: ìì‹ DOMì˜ ë¶€ëª¨ ë˜ëŠ” parentDom ì‚¬ìš©
- **ìì‹ reconcile**: ì¬ê·€ì ìœ¼ë¡œ reconcile í˜¸ì¶œ
- **DOM ì—…ë°ì´íŠ¸**: ì²« DOM ì°¸ì¡° ì—…ë°ì´íŠ¸

---

### 6. `reconcileChildren` (`core/reconciler.ts`)

**ì²˜ë¦¬ ìˆœì„œ**:

1. Key ê¸°ë°˜ Map ìƒì„±
2. ìƒˆ ìì‹ ì²˜ë¦¬ (keyë¡œ ë§¤ì¹­ ë˜ëŠ” ìƒˆë¡œ ë§ˆìš´íŠ¸)
3. ì‚¬ìš©ë˜ì§€ ì•Šì€ ê¸°ì¡´ ìì‹ ì œê±°

**í•µì‹¬ ë¡œì§**:

```typescript
const reconcileChildren = (
  parentDom: HTMLElement,
  instance: Instance,
  newChildren: VNode[],
  parentPath: string,
): void => {
  const oldChildren = instance.children || [];
  const childInstances: (Instance | null)[] = [];

  // Key ê¸°ë°˜ Map ìƒì„±
  const keyMap = new Map<string | number, Instance>();
  for (const oldChild of oldChildren) {
    if (oldChild && oldChild.key !== null) {
      keyMap.set(oldChild.key, oldChild);
    }
  }

  const usedKeys = new Set<string | number>();

  // ìƒˆ ìì‹ ì²˜ë¦¬
  for (let i = 0; i < newChildren.length; i++) {
    const newChild = newChildren[i];
    if (isEmptyValue(newChild)) {
      childInstances.push(null);
      continue;
    }

    let childInstance: Instance | null = null;

    // Keyë¡œ ë§¤ì¹­
    if (newChild.key !== null && keyMap.has(newChild.key)) {
      const matched = keyMap.get(newChild.key)!;
      if (matched.node.type === newChild.type) {
        childInstance = reconcile(parentDom, matched, newChild, childPath);
        usedKeys.add(newChild.key);
      }
    }

    // Keyë¡œ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­
    if (!childInstance && i < oldChildren.length) {
      const oldChild = oldChildren[i];
      if (oldChild && oldChild.node.type === newChild.type && oldChild.key === null) {
        childInstance = reconcile(parentDom, oldChild, newChild, childPath);
      }
    }

    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ë§ˆìš´íŠ¸
    if (!childInstance) {
      childInstance = mount(parentDom, newChild, childPath);
    }

    childInstances.push(childInstance);
  }

  // ì‚¬ìš©ë˜ì§€ ì•Šì€ ê¸°ì¡´ ìì‹ ì œê±°
  for (let i = 0; i < oldChildren.length; i++) {
    const oldChild = oldChildren[i];
    if (!oldChild) continue;

    if (oldChild.key !== null && !usedKeys.has(oldChild.key)) {
      removeInstance(parentDom, oldChild);
    } else if (oldChild.key === null && i >= newChildren.length) {
      removeInstance(parentDom, oldChild);
    }
  }

  instance.children = childInstances;
};
```

**í•µì‹¬ í¬ì¸íŠ¸**:

- **Key ìš°ì„ **: keyê°€ ìˆìœ¼ë©´ keyë¡œ ë§¤ì¹­
- **ì¸ë±ìŠ¤ ë§¤ì¹­**: keyê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­
- **íƒ€ì… í™•ì¸**: íƒ€ì…ì´ ê°™ì•„ì•¼ ì¬ì‚¬ìš©
- **ë¯¸ì‚¬ìš© ì œê±°**: ì‚¬ìš©ë˜ì§€ ì•Šì€ ìì‹ ì œê±°

---

## âœ… í…ŒìŠ¤íŠ¸ í™•ì¸

ì´ ë‹¨ê³„ê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤:

```bash
npm test basic.mini-react.test.tsx
```

**í…ŒìŠ¤íŠ¸ í•­ëª©**:

- ê¸°ë³¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸
- ìƒíƒœ ë³€ê²½ í…ŒìŠ¤íŠ¸
- ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
- ìì‹ ë…¸ë“œ ë³€ê²½ í…ŒìŠ¤íŠ¸
- key ê¸°ë°˜ ìµœì í™” í…ŒìŠ¤íŠ¸

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

### 1. Reconciliation ì „ëµ

| ì¡°ê±´ | ë™ì‘ |
|------|------|
| íƒ€ì…/í‚¤ ë‹¤ë¦„ | ì–¸ë§ˆìš´íŠ¸ í›„ ë§ˆìš´íŠ¸ |
| íƒ€ì…/í‚¤ ê°™ìŒ | ì—…ë°ì´íŠ¸ (DOM ì¬ì‚¬ìš©) |

### 2. ìì‹ ë§¤ì¹­ ìš°ì„ ìˆœìœ„

1. **Keyë¡œ ë§¤ì¹­** (keyê°€ ìˆê³  íƒ€ì…ì´ ê°™ìŒ)
2. **ì¸ë±ìŠ¤ë¡œ ë§¤ì¹­** (keyê°€ ì—†ê³  íƒ€ì…ì´ ê°™ìŒ)
3. **ìƒˆë¡œ ë§ˆìš´íŠ¸** (ë§¤ì¹­ë˜ì§€ ì•ŠìŒ)

### 3. Instance ì¬ì‚¬ìš©

- **ê°™ì€ íƒ€ì…/í‚¤**: DOM ì¬ì‚¬ìš©, ì†ì„±ë§Œ ì—…ë°ì´íŠ¸
- **ë‹¤ë¥¸ íƒ€ì…/í‚¤**: DOM ì œê±° í›„ ìƒˆë¡œ ìƒì„±
- **ì„±ëŠ¥**: ìµœì†Œí•œì˜ DOM ë³€ê²½ìœ¼ë¡œ ìµœì í™”

### 4. ì»´í¬ë„ŒíŠ¸ ê²½ë¡œ

- **ë§ˆìš´íŠ¸**: ìƒˆ ê²½ë¡œ ìƒì„±
- **ì—…ë°ì´íŠ¸**: ê¸°ì¡´ ê²½ë¡œ ì¬ì‚¬ìš© (í›… ìƒíƒœ ìœ ì§€)

---

## ğŸ“š í•™ìŠµ ìš”ì•½

### Reconciliation í”Œë¡œìš°

```
reconcile(parentDom, instance, node, path)
  â”œâ”€ node === null â†’ removeInstance() â†’ return null
  â”œâ”€ !instance â†’ mount() â†’ return newInstance
  â”œâ”€ type/key ë‹¤ë¦„ â†’ removeInstance() â†’ mount() â†’ return newInstance
  â””â”€ type/key ê°™ìŒ â†’ update() â†’ return updatedInstance
```

### ë§ˆìš´íŠ¸ í”Œë¡œìš°

```
mount(parentDom, node, path)
  â”œâ”€ TEXT_ELEMENT â†’ Text ë…¸ë“œ ìƒì„±
  â”œâ”€ Fragment â†’ ìì‹ë§Œ ë§ˆìš´íŠ¸
  â”œâ”€ Component â†’ mountComponent()
  â””â”€ DOM â†’ createElement() â†’ setDomProps() â†’ ìì‹ ë§ˆìš´íŠ¸
```

### ì—…ë°ì´íŠ¸ í”Œë¡œìš°

```
update(oldInstance, newNode, parentDom, path)
  â”œâ”€ TEXT â†’ nodeValue ì—…ë°ì´íŠ¸
  â”œâ”€ Fragment â†’ reconcileChildren()
  â”œâ”€ Component â†’ updateComponent()
  â””â”€ DOM â†’ updateDomProps() â†’ reconcileChildren()
```

### ìì‹ ì¬ì¡°ì • ì „ëµ

1. **Key ê¸°ë°˜**: ë¹ ë¥¸ ë§¤ì¹­, ìœ„ì¹˜ ì´ë™ ê°ì§€
2. **ì¸ë±ìŠ¤ ê¸°ë°˜**: ë‹¨ìˆœ ë§¤ì¹­, ìˆœì„œ ë³€ê²½ ì²˜ë¦¬
3. **ì œê±°**: ì‚¬ìš©ë˜ì§€ ì•Šì€ ìì‹ ì–¸ë§ˆìš´íŠ¸

---

## ğŸ’¡ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜

1. **ê²½ë¡œ ì¬ì‚¬ìš©**: updateComponentì—ì„œ ìƒˆ ê²½ë¡œ ìƒì„±í•˜ë©´ í›… ìƒíƒœ ì†ì‹¤ âŒ
2. **íƒ€ì… í™•ì¸ ëˆ„ë½**: ìì‹ ë§¤ì¹­ ì‹œ íƒ€ì… í™•ì¸ ì•ˆ í•¨ âŒ
3. **ì»¨í…Œì´ë„ˆ ì°¾ê¸°**: ìì‹ DOMì˜ ë¶€ëª¨ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì°¾ì§€ ì•ŠìŒ âŒ
4. **try-finally ëˆ„ë½**: enterComponent/exitComponent ìŒ ë³´ì¥ ì•ˆ í•¨ âŒ
5. **Key ë§¤ì¹­ ìš°ì„ **: Keyê°€ ìˆìœ¼ë©´ ì¸ë±ìŠ¤ ë¬´ì‹œ âŒ

---

ë‹¤ìŒ ë‹¨ê³„: **ë‹¨ê³„ 6 - ê¸°ë³¸ Hook ì‹œìŠ¤í…œ**

